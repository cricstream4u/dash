<!DOCTYPE html>
<html>
<head>
    <title>DASH Player with Plyr</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <style>
        .video-container {
            width: 95%;
            height: auto;
            position: relative;
        }

        @media (max-width: 768px) {
            .video-container {
                width: 100%;
            }
        }

        .plyr--hide-controls {
            opacity: 1 !important; /* Ensure controls are always visible when active */
        }
    </style>
</head>
<body>
    <center>
        <div class="video-container">
            <video id="video" controls crossorigin></video>
        </div>
    </center>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get('video');

            if (!videoUrl || !videoUrl.endsWith('.mpd')) {
                document.body.innerHTML = "<h2>Valid DASH (.mpd) URL is required in the query parameter.</h2>";
                return;
            }

            const video = document.getElementById('video');

            const dashPlayer = dashjs.MediaPlayer().create();
            dashPlayer.initialize(video, videoUrl, true);

            dashPlayer.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
                const bitrates = dashPlayer.getBitrateInfoListFor("video").map(b => b.height);

                const player = new Plyr(video, {
                    controls: [
                        'play-large',
                        'play',
                        'progress',
                        'duration',
                        'mute',
                        'settings',
                        'pip',
                        'airplay',
                        'fullscreen',
                    ],
                    settings: ['quality'],
                    quality: {
                        default: 0,
                        options: [0, ...bitrates],
                        forced: true,
                        onChange: (newQuality) => {
                            if (newQuality === 0) {
                                dashPlayer.setAutoSwitchQualityFor("video", true);
                            } else {
                                dashPlayer.setAutoSwitchQualityFor("video", false);
                                const index = dashPlayer.getBitrateInfoListFor("video").findIndex(b => b.height === newQuality);
                                dashPlayer.setQualityFor("video", index);
                            }
                        },
                    },
                });

                // Attach fullscreen and play/pause handlers
                attachFullscreenOrientationHandler(player);
                attachPlayPauseHandler(player);
            });
        });

        function attachFullscreenOrientationHandler(player) {
            player.on('enterfullscreen', () => {
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(err => {
                        console.warn('Failed to lock screen orientation:', err);
                    });
                }
            });

            player.on('exitfullscreen', () => {
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            });
        }

        function attachPlayPauseHandler(player) {
            player.on('play', () => {
                const playLargeButton = document.querySelector('.plyr__control--overlaid');
                if (playLargeButton) {
                    playLargeButton.style.display = 'none';
                }
            });

            player.on('pause', () => {
                const playLargeButton = document.querySelector('.plyr__control--overlaid');
                if (playLargeButton) {
                    playLargeButton.style.display = '';
                }
            });

            player.elements.container.addEventListener('mousemove', () => {
                player.elements.container.classList.remove('plyr--hide-controls');
            });
        }
    </script>
</body>
</html>
