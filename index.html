<!DOCTYPE html>
<html>
<head>
    <title>DASH Player with Plyr</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <style>
        .video-container {
            width: 95%;
            height: auto;
        }

        @media (max-width: 768px) {
            .video-container {
                width: 100%;
            }
        }

        /* Ensure play-large button is hidden after play starts */
        .plyr--playing .plyr__control--overlaid {
            display: none !important;
        }

        /* Always show controls on hover */
        .plyr:hover .plyr__controls {
            opacity: 1 !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
    <center>
        <div class="video-container">
            <video preload="none" id="video" autoplay controls crossorigin></video>
        </div>
    </center>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get('video');

            if (!videoUrl) {
                document.body.innerHTML = "<h2>Video URL missing in query parameter</h2>";
                return;
            }

            const video = document.getElementById('video');
            const defaultOptions = {
                controls: [
                    'play-large',
                    'play',
                    'progress',
                    'duration',
                    'mute',
                    'settings',
                    'pip',
                    'airplay',
                    'fullscreen',
                ],
                settings: ['quality'],
                quality: {
                    default: 0,
                    options: [],
                    forced: true,
                    onChange: (quality) => console.log(`Quality changed to: ${quality}`),
                },
            };

            if (videoUrl.endsWith('.mpd')) {
                const dashPlayer = dashjs.MediaPlayer().create();
                dashPlayer.initialize(video, videoUrl, true);

                dashPlayer.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
                    const bitrates = dashPlayer.getBitrateInfoListFor("video").map(b => b.height);

                    defaultOptions.quality.options = [0, ...bitrates];
                    defaultOptions.quality.onChange = (newQuality) => {
                        if (newQuality === 0) {
                            dashPlayer.setAutoSwitchQualityFor("video", true);
                        } else {
                            dashPlayer.setAutoSwitchQualityFor("video", false);
                            const index = dashPlayer.getBitrateInfoListFor("video").findIndex(b => b.height === newQuality);
                            dashPlayer.setQualityFor("video", index);
                        }
                    };

                    const player = new Plyr(video, defaultOptions);

                    // Attach event handlers
                    attachPlayPauseHandler(player);
                    attachFullscreenOrientationHandler(player);
                });
            } else {
                document.body.innerHTML = "<h2>Only DASH (.mpd) format is supported</h2>";
            }
        });

        function attachPlayPauseHandler(player) {
            // Hide the large play button after playback starts
            player.on('play', () => {
                const playLargeButton = document.querySelector('.plyr__control--overlaid');
                if (playLargeButton) {
                    playLargeButton.style.display = 'none';
                }
            });

            // Show the large play button when paused
            player.on('pause', () => {
                const playLargeButton = document.querySelector('.plyr__control--overlaid');
                if (playLargeButton) {
                    playLargeButton.style.display = '';
                }
            });

            // Always show controls on hover or interaction
            player.on('mouseover', () => {
                player.elements.controls.style.opacity = '1';
                player.elements.controls.style.visibility = 'visible';
            });

            player.on('mouseleave', () => {
                if (!player.playing) {
                    player.elements.controls.style.opacity = '';
                    player.elements.controls.style.visibility = '';
                }
            });
        }

        function attachFullscreenOrientationHandler(player) {
            player.on('enterfullscreen', () => {
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(err => {
                        console.warn('Failed to lock screen orientation:', err);
                    });
                }
            });

            player.on('exitfullscreen', () => {
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock().catch(err => {
                        console.warn('Failed to unlock screen orientation:', err);
                    });
                }
            });
        }
    </script>
</body>
</html>
