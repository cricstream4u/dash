<!DOCTYPE html>
<html>
<head>
    <title>DASH & HLS Player with Plyr</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <style>
        .video-container {
            width: 95%;
            height: auto;
        }

        @media (max-width: 768px) {
            .video-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>
   <center>
    <div class="video-container">
        <video preload="none" id="video" autoplay controls crossorigin></video>
    </div>
    </center>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get('video');

            if (!videoUrl) {
                document.body.innerHTML = "<h2>Video URL missing in query parameter</h2>";
                return;
            }

            const video = document.getElementById('video');
            const defaultOptions = {
                controls: [
                    'play-large',
                    'play',
                    'progress',
                    'duration',
                    'mute',
                    'settings',
                    'pip',
                    'airplay',
                    'fullscreen',
                ],
                settings: ['quality'],
                quality: {
                    default: 0,
                    options: [], // Filled dynamically
                    forced: true,
                    onChange: (quality) => console.log(`Quality changed to: ${quality}`),
                },
            };

            if (videoUrl.endsWith('.mpd')) {
                // DASH Support
                const dashPlayer = dashjs.MediaPlayer().create();
                dashPlayer.initialize(video, videoUrl, true);

                dashPlayer.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
                    const bitrates = dashPlayer.getBitrateInfoListFor("video").map(b => b.height);
                    defaultOptions.quality.options = [0, ...bitrates]; // 0 for Auto
                    defaultOptions.quality.onChange = (newQuality) => {
                        if (newQuality === 0) {
                            dashPlayer.setAutoSwitchQualityFor("video", true);
                        } else {
                            dashPlayer.setAutoSwitchQualityFor("video", false);
                            const index = dashPlayer.getBitrateInfoListFor("video").findIndex(b => b.height === newQuality);
                            dashPlayer.setQualityFor("video", index);
                        }
                    };

                    const player = new Plyr(video, defaultOptions);
                });
            } else if (Hls.isSupported() && videoUrl.endsWith('.m3u8')) {
                // HLS Support
                const hls = new Hls();
                hls.loadSource(videoUrl);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    const availableQualities = hls.levels.map(level => level.height);
                    defaultOptions.quality.options = [0, ...availableQualities]; // 0 for Auto
                    defaultOptions.quality.onChange = (newQuality) => updateQuality(hls, newQuality);

                    const player = new Plyr(video, defaultOptions);
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl') || video.canPlayType('application/dash+xml')) {
                video.src = videoUrl;
                const player = new Plyr(video, defaultOptions);
            } else {
                document.body.innerHTML = "<h2>Neither HLS nor DASH is supported on your browser</h2>";
            }
        });

        function updateQuality(hls, newQuality) {
            if (newQuality === 0) {
                hls.currentLevel = -1; // Auto
            } else {
                const index = hls.levels.findIndex(level => level.height === newQuality);
                if (index !== -1) {
                    hls.currentLevel = index;
                }
            }
        }
    </script>
</body>
</html>
