<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS and DASH Player with Plyr (Enhanced)</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <style>
        .video-container {
            width: 95%;
            max-width: 100%;
            margin: 0 auto;
        }

        video:fullscreen {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        @media (max-width: 768px) {
            .video-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <center>
        <div class="video-container">
            <video preload="none" id="video" autoplay controls crossorigin></video>
        </div>
    </center>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get('video') || 'https://mafiatv.live/watch.php?id=e11f5fd4a4f8d93211d512209b24111c15593bd2484daf7fd8c890afebdddea45c16e7420649d322b6ca99cc54024d4a&e=.m3u8';

            if (!videoUrl) {
                document.body.innerHTML = "<h2>Video URL missing in query parameter</h2>";
                return;
            }

            try {
                // Validate the video URL
                const isValid = await validateVideoUrl(videoUrl);
                if (!isValid) {
                    document.body.innerHTML = "<h2>Failed to load video. Please check the URL or try again later.</h2>";
                    return;
                }

                const video = document.getElementById('video');
                const defaultOptions = {
                    controls: [
                        'play-large',
                        'play',
                        'progress',
                        'duration',
                        'mute',
                        'volume',
                        'settings',
                        'fullscreen',
                    ],
                    settings: ['quality'],
                };

                if (videoUrl.endsWith('.m3u8')) {
                    // HLS Stream
                    if (Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(videoUrl);
                        hls.attachMedia(video);

                        hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            const availableQualities = hls.levels.map(level => level.height);
                            defaultOptions.quality = {
                                default: 0,
                                options: availableQualities,
                                forced: true,
                                onChange: (newQuality) => updateHlsQuality(hls, newQuality),
                            };

                            const player = new Plyr(video, defaultOptions);
                        });

                        hls.on(Hls.Events.ERROR, (event, data) => {
                            if (data.fatal) {
                                console.error('HLS.js fatal error:', data);
                                alert('An error occurred while loading the video.');
                            }
                        });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = videoUrl;
                        const player = new Plyr(video, defaultOptions);
                    } else {
                        document.body.innerHTML = "<h2>HLS not supported on your browser</h2>";
                    }
                } else {
                    document.body.innerHTML = "<h2>Unsupported video format</h2>";
                }
            } catch (error) {
                console.error('Error loading video:', error);
                document.body.innerHTML = "<h2>An error occurred while loading the video</h2>";
            }
        });

        // Function to validate the video URL
        async function validateVideoUrl(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch (error) {
                console.error('Validation failed for URL:', error);
                return false;
            }
        }

        // Function to update HLS quality
        function updateHlsQuality(hls, newQuality) {
            if (newQuality === 0) {
                hls.currentLevel = -1; // Auto quality
            } else {
                hls.levels.forEach((level, index) => {
                    if (level.height === newQuality) {
                        hls.currentLevel = index;
                    }
                });
            }
        }
    </script>
</body>
</html>
