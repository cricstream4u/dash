<!DOCTYPE html>
<html>
<head>
    <title>DASH Player with Plyr</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <style>
        .video-container {
            width: 95%;
            height: auto;
        }

        @media (max-width: 768px) {
            .video-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <center>
        <div class="video-container">
            <video preload="none" id="video" autoplay controls crossorigin></video>
        </div>
    </center>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get('video');

            if (!videoUrl) {
                document.body.innerHTML = "<h2>Video URL missing in query parameter</h2>";
                return;
            }

            const video = document.getElementById('video');
            const defaultOptions = {
                controls: [
                    'play-large',
                    'play',
                    'progress',
                    'duration',
                    'mute',
                    'settings',
                    'pip',
                    'airplay',
                    'fullscreen',
                ],
                settings: ['quality'],
                quality: {
                    default: 0,
                    options: [],
                    forced: true,
                    onChange: (quality) => console.log(`Quality changed to: ${quality}`),
                },
            };

            if (videoUrl.endsWith('.mpd')) {
                const dashPlayer = dashjs.MediaPlayer().create();
                dashPlayer.initialize(video, videoUrl, true);

                dashPlayer.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
                    const bitrates = dashPlayer.getBitrateInfoListFor("video").map(b => b.height);

                    defaultOptions.quality.options = [0, ...bitrates];
                    defaultOptions.quality.onChange = (newQuality) => {
                        if (newQuality === 0) {
                            dashPlayer.setAutoSwitchQualityFor("video", true);
                        } else {
                            dashPlayer.setAutoSwitchQualityFor("video", false);
                            const index = dashPlayer.getBitrateInfoListFor("video").findIndex(b => b.height === newQuality);
                            dashPlayer.setQualityFor("video", index);
                        }
                    };

                    const player = new Plyr(video, defaultOptions);

                    // Attach fullscreen orientation handling
                    attachFullscreenOrientationHandler(player);
                });
            } else {
                document.body.innerHTML = "<h2>Only DASH (.mpd) format is supported</h2>";
            }
        });

        function attachFullscreenOrientationHandler(player) {
            player.on('enterfullscreen', () => {
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(err => {
                        console.warn('Failed to lock screen orientation:', err);
                    });
                }
            });

            player.on('exitfullscreen', () => {
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock().catch(err => {
                        console.warn('Failed to unlock screen orientation:', err);
                    });
                }
            });
        }
    </script>

    <!-- BEGIN: Powered by Supercounters.com -->
    <center>
        <script type="text/javascript" src="//widget.supercounters.com/ssl/online_t.js"></script>
        <script type="text/javascript">sc_online_t(1703448,"Watching....","#1d1d21");</script>
        <br>
        <noscript><a href="https://www.supercounters.com/"></a></noscript>
    </center>
    <!-- END: Powered by Supercounters.com -->

    <div style="background-color: #0074d9; text-align: center; padding: 10px;">
        <a href="https://telegram.me/cric_stream" target="_blank">
            <button id="joinTelegramButton" style="background-color: #fff; color: #0074d9; border: 2px solid #0074d9; padding: 5px 10px;">Join Telegram</button>
        </a>
    </div>
</body>
</html>
